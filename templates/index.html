<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinanceApp - Sistema Banc√°rio Digital</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #2563eb;
            --primary-hover: #1d4ed8;
            --secondary-color: #64748b;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --background-color: #f8fafc;
            --surface-color: #ffffff;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --border-color: #e5e7eb;
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--background-color);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .app-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-hover) 100%);
            color: white;
            padding: 1rem 0;
            box-shadow: var(--shadow-lg);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: rgba(255, 255, 255, 0.1);
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            backdrop-filter: blur(10px);
        }

        /* Main Layout */
        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            flex: 1;
        }

        /* Login Section */
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 80vh;
            padding: 2rem;
        }

        .auth-card {
            background: var(--surface-color);
            padding: 3rem;
            border-radius: 1rem;
            box-shadow: var(--shadow-lg);
            width: 100%;
            max-width: 400px;
        }

        .auth-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .auth-header h2 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .auth-header p {
            color: var(--text-secondary);
        }

        /* Forms */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        .form-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid var(--border-color);
            border-radius: 0.5rem;
            font-size: 1rem;
            transition: all 0.2s;
            background: var(--surface-color);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .form-input.error {
            border-color: var(--danger-color);
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            min-height: 44px;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-hover);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: var(--secondary-color);
            color: white;
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-warning {
            background: var(--warning-color);
            color: white;
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--border-color);
            color: var(--text-primary);
        }

        .btn-full {
            width: 100%;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Cards */
        .card {
            background: var(--surface-color);
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-hover) 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: var(--shadow);
        }

        .stat-card.success {
            background: linear-gradient(135deg, var(--success-color) 0%, #059669 100%);
        }

        .stat-card.warning {
            background: linear-gradient(135deg, var(--warning-color) 0%, #d97706 100%);
        }

        .stat-card.danger {
            background: linear-gradient(135deg, var(--danger-color) 0%, #dc2626 100%);
        }

        .stat-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .stat-label {
            font-size: 0.875rem;
            opacity: 0.9;
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            backdrop-filter: blur(4px);
        }

        .modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 2rem;
        }

        .modal-content {
            background: var(--surface-color);
            border-radius: 1rem;
            padding: 2rem;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 0.5rem;
            border-radius: 0.25rem;
        }

        .modal-close:hover {
            background: var(--border-color);
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            background: var(--surface-color);
            border-radius: 0.5rem;
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .table th,
        .table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .table th {
            background: var(--background-color);
            font-weight: 600;
            color: var(--text-primary);
        }

        .table tr:hover {
            background: var(--background-color);
        }

        /* Notifications */
        .notification {
            position: fixed;
            top: 2rem;
            right: 2rem;
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            color: white;
            font-weight: 500;
            box-shadow: var(--shadow-lg);
            z-index: 1001;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: var(--success-color);
        }

        .notification.error {
            background: var(--danger-color);
        }

        .notification.warning {
            background: var(--warning-color);
        }

        /* Status de conex√£o WebSocket */
        .connection-status {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            padding: 0.75rem 1.25rem;
            border-radius: 2rem;
            background: var(--surface-color);
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            z-index: 1000;
            border: 2px solid var(--border-color);
        }

        .connection-status.connected {
            border-color: var(--success-color);
            color: var(--success-color);
        }

        .connection-status.disconnected {
            border-color: var(--danger-color);
            color: var(--danger-color);
        }

        .connection-pulse {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: currentColor;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        /* Utilities */
        .hidden {
            display: none !important;
        }

        .text-right {
            text-align: right;
        }

        .text-center {
            text-align: center;
        }

        .text-success {
            color: var(--success-color);
        }

        .text-danger {
            color: var(--danger-color);
        }

        .text-warning {
            color: var(--warning-color);
        }

        .mb-0 {
            margin-bottom: 0;
        }

        .mb-1 {
            margin-bottom: 0.5rem;
        }

        .mb-2 {
            margin-bottom: 1rem;
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header-content {
                padding: 0 1rem;
            }

            .main-container {
                padding: 1rem;
            }

            .auth-card {
                padding: 2rem;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .modal-content {
                margin: 1rem;
                padding: 1.5rem;
            }

            .notification {
                top: 1rem;
                right: 1rem;
                left: 1rem;
                transform: translateY(-100px);
            }

            .notification.show {
                transform: translateY(0);
            }
        }

        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .user-info {
                display: none;
            }

            .table th,
            .table td {
                padding: 0.5rem;
                font-size: 0.875rem;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="header hidden" id="main-header">
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-university"></i>
                    FinanceApp
                </div>
                <div class="user-menu">
                    <div class="user-info">
                        <i class="fas fa-user-circle"></i>
                        <span id="header-user-name">Usu√°rio</span>
                    </div>
                    <button class="btn btn-secondary" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i>
                        Sair
                    </button>
                </div>
            </div>
        </header>

        <!-- Login/Register Section -->
        <div id="auth-container" class="auth-container">
            <div class="auth-card">
                <!-- Login Form -->
                <div id="login-form">
                    <div class="auth-header">
                        <i class="fas fa-university" style="font-size: 3rem; color: var(--primary-color); margin-bottom: 1rem;"></i>
                        <h2>FinanceApp</h2>
                        <p>Entre em sua conta para acessar seus servi√ßos banc√°rios</p>
                    </div>
                    
                    <form id="loginFormElement" onsubmit="fazerLogin(event)">
                        <div class="form-group">
                            <label class="form-label" for="loginEmail">Email</label>
                            <input type="email" id="loginEmail" class="form-input" placeholder="seu@email.com" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="loginSenha">Senha</label>
                            <input type="password" id="loginSenha" class="form-input" placeholder="Sua senha" required>
                        </div>
                        <button type="submit" class="btn btn-primary btn-full" id="loginBtn">
                            <i class="fas fa-sign-in-alt"></i>
                            Entrar
                        </button>
                    </form>
                    
                    <p class="text-center" style="margin-top: 1.5rem; color: var(--text-secondary);">
                        N√£o tem uma conta? 
                        <a href="#" onclick="mostrarRegistro()" style="color: var(--primary-color); text-decoration: none;">Registre-se</a>
                    </p>
                </div>

                <!-- Register Form -->
                <div id="registro-form" class="hidden">
                    <div class="auth-header">
                        <i class="fas fa-user-plus" style="font-size: 3rem; color: var(--primary-color); margin-bottom: 1rem;"></i>
                        <h2>Criar Conta</h2>
                        <p>Registre-se para acessar nossos servi√ßos banc√°rios</p>
                    </div>
                    
                    <form id="registerFormElement" onsubmit="fazerRegistro(event)">
                        <div class="form-group">
                            <label class="form-label" for="regNome">Nome completo</label>
                            <input type="text" id="regNome" class="form-input" placeholder="Seu nome completo" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="regEmail">Email</label>
                            <input type="email" id="regEmail" class="form-input" placeholder="seu@email.com" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="regSenha">Senha</label>
                            <input type="password" id="regSenha" class="form-input" placeholder="M√≠nimo 6 caracteres" required>
                        </div>
                        <button type="submit" class="btn btn-primary btn-full" id="registerBtn">
                            <i class="fas fa-user-plus"></i>
                            Registrar
                        </button>
                    </form>
                    
                    <p class="text-center" style="margin-top: 1.5rem; color: var(--text-secondary);">
                        J√° tem uma conta? 
                        <a href="#" onclick="mostrarLogin()" style="color: var(--primary-color); text-decoration: none;">Fa√ßa login</a>
                    </p>
                </div>
            </div>
        </div>

        <!-- Main Application -->
        <div id="main-app" class="main-container hidden">
            <!-- Dashboard Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-wallet"></i>
                    </div>
                    <div class="stat-value" id="saldo-total">R$ 0,00</div>
                    <div class="stat-label">Saldo Total</div>
                </div>
                <div class="stat-card success">
                    <div class="stat-icon">
                        <i class="fas fa-arrow-down"></i>
                    </div>
                    <div class="stat-value" id="total-receitas">R$ 0,00</div>
                    <div class="stat-label">Receitas</div>
                </div>
                <div class="stat-card danger">
                    <div class="stat-icon">
                        <i class="fas fa-arrow-up"></i>
                    </div>
                    <div class="stat-value" id="total-despesas">R$ 0,00</div>
                    <div class="stat-label">Despesas</div>
                </div>
                <div class="stat-card warning">
                    <div class="stat-icon">
                        <i class="fas fa-exchange-alt"></i>
                    </div>
                    <div class="stat-value" id="total-movimentacoes">0</div>
                    <div class="stat-label">Movimenta√ß√µes</div>
                </div>
            </div>

            <!-- Main Content Grid -->
            <div class="dashboard-grid">
                <!-- Quick Actions -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-bolt"></i>
                            A√ß√µes R√°pidas
                        </h3>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                        <button class="btn btn-success" onclick="abrirModal('deposito')">
                            <i class="fas fa-plus"></i>
                            Dep√≥sito
                        </button>
                        <button class="btn btn-danger" onclick="abrirModal('saque')">
                            <i class="fas fa-minus"></i>
                            Saque
                        </button>
                        <button class="btn btn-primary" onclick="abrirModal('transferencia')">
                            <i class="fas fa-exchange-alt"></i>
                            Transferir
                        </button>
                        <button class="btn btn-warning" onclick="abrirModal('pagamento')">
                            <i class="fas fa-credit-card"></i>
                            Pagar
                        </button>
                    </div>
                </div>

                <!-- Account Summary -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-user"></i>
                            Minhas Contas
                        </h3>
                        <button class="btn btn-outline" onclick="carregarCorrentistas()">
                            <i class="fas fa-sync"></i>
                            Atualizar
                        </button>
                    </div>
                    <div id="contas-lista">
                        <p class="text-center" style="color: var(--text-secondary); padding: 2rem;">
                            Carregando contas...
                        </p>
                    </div>
                </div>
            </div>

            <!-- Recent Transactions -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-history"></i>
                        Movimenta√ß√µes Recentes
                    </h3>
                    <button class="btn btn-outline" onclick="carregarMovimentacoes()">
                        <i class="fas fa-sync"></i>
                        Atualizar
                    </button>
                </div>
                <div class="table-container">
                    <table class="table" id="movimentacoes-table">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Tipo</th>
                                <th>Descri√ß√£o</th>
                                <th>Valor</th>
                                <th>Conta</th>
                            </tr>
                        </thead>
                        <tbody id="movimentacoes-tbody">
                            <tr>
                                <td colspan="5" class="text-center" style="padding: 2rem; color: var(--text-secondary);">
                                    Carregando movimenta√ß√µes...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Modals -->
        <!-- Dep√≥sito Modal -->
        <div id="depositoModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3><i class="fas fa-plus"></i> Realizar Dep√≥sito</h3>
                    <button class="modal-close" onclick="fecharModal('depositoModal')">&times;</button>
                </div>
                <form id="depositoForm" onsubmit="realizarDeposito(event)">
                    <div class="form-group">
                        <label class="form-label" for="depositoConta">Conta</label>
                        <select id="depositoConta" class="form-input" required>
                            <option value="">Selecione uma conta</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="depositoValor">Valor (R$)</label>
                        <input type="number" id="depositoValor" class="form-input" placeholder="0,00" step="0.01" min="0.01" required>
                    </div>
                    <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                        <button type="button" class="btn btn-secondary" onclick="fecharModal('depositoModal')">Cancelar</button>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-plus"></i>
                            Depositar
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Saque Modal -->
        <div id="saqueModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3><i class="fas fa-minus"></i> Realizar Saque</h3>
                    <button class="modal-close" onclick="fecharModal('saqueModal')">&times;</button>
                </div>
                <form id="saqueForm" onsubmit="realizarSaque(event)">
                    <div class="form-group">
                        <label class="form-label" for="saqueConta">Conta</label>
                        <select id="saqueConta" class="form-input" required>
                            <option value="">Selecione uma conta</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="saqueValor">Valor (R$)</label>
                        <input type="number" id="saqueValor" class="form-input" placeholder="0,00" step="0.01" min="0.01" required>
                    </div>
                    <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                        <button type="button" class="btn btn-secondary" onclick="fecharModal('saqueModal')">Cancelar</button>
                        <button type="submit" class="btn btn-danger">
                            <i class="fas fa-minus"></i>
                            Sacar
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Transfer√™ncia Modal -->
        <div id="transferenciaModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3><i class="fas fa-exchange-alt"></i> Realizar Transfer√™ncia</h3>
                    <button class="modal-close" onclick="fecharModal('transferenciaModal')">&times;</button>
                </div>
                <form id="transferenciaForm" onsubmit="realizarTransferencia(event)">
                    <div class="form-group">
                        <label class="form-label" for="transferenciaOrigem">Conta de Origem</label>
                        <select id="transferenciaOrigem" class="form-input" required>
                            <option value="">Selecione a conta de origem</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="transferenciaDestino">Conta de Destino</label>
                        <select id="transferenciaDestino" class="form-input" required>
                            <option value="">Selecione a conta de destino</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="transferenciaValor">Valor (R$)</label>
                        <input type="number" id="transferenciaValor" class="form-input" placeholder="0,00" step="0.01" min="0.01" required>
                    </div>
                    <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                        <button type="button" class="btn btn-secondary" onclick="fecharModal('transferenciaModal')">Cancelar</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-exchange-alt"></i>
                            Transferir
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Pagamento Modal -->
        <div id="pagamentoModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3><i class="fas fa-credit-card"></i> Realizar Pagamento</h3>
                    <button class="modal-close" onclick="fecharModal('pagamentoModal')">&times;</button>
                </div>
                <form id="pagamentoForm" onsubmit="realizarPagamento(event)">
                    <div class="form-group">
                        <label class="form-label" for="pagamentoConta">Conta</label>
                        <select id="pagamentoConta" class="form-input" required>
                            <option value="">Selecione uma conta</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="pagamentoDescricao">Descri√ß√£o</label>
                        <input type="text" id="pagamentoDescricao" class="form-input" placeholder="Ex: Conta de luz" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="pagamentoValor">Valor (R$)</label>
                        <input type="number" id="pagamentoValor" class="form-input" placeholder="0,00" step="0.01" min="0.01" required>
                    </div>
                    <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                        <button type="button" class="btn btn-secondary" onclick="fecharModal('pagamentoModal')">Cancelar</button>
                        <button type="submit" class="btn btn-warning">
                            <i class="fas fa-credit-card"></i>
                            Pagar
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Notification Container -->
        <div id="notification-container"></div>

        <!-- Connection Status Indicator -->
        <div id="connection-status" class="connection-status disconnected">
            <div class="connection-pulse"></div>
            <span id="connection-text">Desconectado</span>
        </div>
    </div>

    <script>
        // Global Variables
        let authToken = localStorage.getItem('authToken');
        let currentUser = null;
        let correntistas = [];
        let socket = null;
        let isSocketConnected = false;

        // Initialize App
        document.addEventListener('DOMContentLoaded', function() {
            initSocketIO();
            
            if (authToken) {
                verificarToken();
            }
        });

        // Utility Functions
        function formatarMoeda(valor) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(valor);
        }

        function formatarData(dataString) {
            const data = new Date(dataString);
            return data.toLocaleDateString('pt-BR') + ' ' + data.toLocaleTimeString('pt-BR');
        }

        function mostrarNotificacao(mensagem, tipo = 'success') {
            const container = document.getElementById('notification-container');
            const notification = document.createElement('div');
            notification.className = `notification ${tipo}`;
            notification.innerHTML = `
                <i class="fas fa-${tipo === 'success' ? 'check' : tipo === 'error' ? 'times' : 'exclamation'}"></i>
                ${mensagem}
            `;
            
            container.appendChild(notification);
            
            // Show notification
            setTimeout(() => notification.classList.add('show'), 100);
            
            // Remove notification after 4 seconds
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => container.removeChild(notification), 300);
            }, 4000);
        }

        function setLoading(element, loading = true) {
            if (loading) {
                element.classList.add('loading');
                element.disabled = true;
            } else {
                element.classList.remove('loading');
                element.disabled = false;
            }
        }

        // =====================================
        // WebSocket Functions
        // =====================================
        function initSocketIO() {
            console.log('Inicializando Socket.IO...');
            socket = io({
                transports: ['websocket', 'polling'],
                reconnection: true,
                reconnectionDelay: 1000,
                reconnectionDelayMax: 5000,
                reconnectionAttempts: 5
            });

            // Evento: Conex√£o estabelecida
            socket.on('connect', function() {
                console.log('WebSocket conectado!');
                isSocketConnected = true;
                atualizarStatusConexao(true);
                
                // Se estiver autenticado, enviar token
                if (authToken) {
                    autenticarWebSocket();
                }
            });

            // Evento: Desconex√£o
            socket.on('disconnect', function() {
                console.log('WebSocket desconectado');
                isSocketConnected = false;
                atualizarStatusConexao(false);
            });

            // Evento: Erro de conex√£o
            socket.on('connect_error', function(error) {
                console.error('Erro de conex√£o WebSocket:', error);
                isSocketConnected = false;
                atualizarStatusConexao(false);
            });

            // Evento: Conex√£o confirmada
            socket.on('conexao', function(data) {
                console.log('Mensagem do servidor:', data.mensagem);
            });

            // Evento: Autentica√ß√£o bem-sucedida
            socket.on('autenticado', function(data) {
                console.log('Autenticado no WebSocket:', data);
                mostrarNotificacao('Conex√£o em tempo real ativada! üîî', 'success');
            });

            // Evento: Erro
            socket.on('erro', function(data) {
                console.error('Erro WebSocket:', data.mensagem);
            });

            // Evento: Notifica√ß√£o em tempo real
            socket.on('notificacao', function(data) {
                console.log('Notifica√ß√£o recebida:', data);
                
                // Mostrar notifica√ß√£o visual
                const icones = {
                    'deposito': 'fa-plus-circle',
                    'saque': 'fa-minus-circle',
                    'transferencia': 'fa-exchange-alt',
                    'pagamento': 'fa-credit-card'
                };
                
                const icone = icones[data.tipo] || 'fa-bell';
                
                mostrarNotificacao(`
                    <i class="fas ${icone}"></i> ${data.mensagem}
                `, 'success');
                
                // Atualizar dashboard automaticamente
                setTimeout(() => {
                    carregarDashboard();
                }, 500);
            });

            // Evento: Saldo atualizado
            socket.on('saldo_atualizado', function(data) {
                console.log('Saldo atualizado:', data);
                
                // Atualizar o saldo na lista de contas
                const conta = correntistas.find(c => c.CorrentistaID === data.CorrentistaID);
                if (conta) {
                    conta.Saldo = data.Saldo;
                    atualizarListaContas();
                    atualizarSelectsContas();
                    atualizarEstatisticas();
                }
            });
        }

        function autenticarWebSocket() {
            if (socket && isSocketConnected && authToken) {
                console.log('Autenticando WebSocket com token...');
                socket.emit('autenticar', { token: authToken });
            }
        }

        function atualizarStatusConexao(conectado) {
            const statusEl = document.getElementById('connection-status');
            const textEl = document.getElementById('connection-text');
            
            if (conectado) {
                statusEl.classList.remove('disconnected');
                statusEl.classList.add('connected');
                textEl.textContent = 'Conectado';
            } else {
                statusEl.classList.remove('connected');
                statusEl.classList.add('disconnected');
                textEl.textContent = 'Desconectado';
            }
        }

        function solicitarSaldoAtualizado(contaId) {
            if (socket && isSocketConnected && authToken) {
                socket.emit('solicitar_saldo', {
                    token: authToken,
                    correntista_id: contaId
                });
            }
        }

        // =====================================
        // Authentication Functions
        // =====================================
        function mostrarLogin() {
            document.getElementById('login-form').classList.remove('hidden');
            document.getElementById('registro-form').classList.add('hidden');
            limparFormularios();
        }

        function mostrarRegistro() {
            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('registro-form').classList.remove('hidden');
            limparFormularios();
        }

        function limparFormularios() {
            document.querySelectorAll('form').forEach(form => form.reset());
            document.querySelectorAll('.form-input.error').forEach(input => 
                input.classList.remove('error')
            );
        }

        async function fazerLogin(event) {
            event.preventDefault();
            
            const email = document.getElementById('loginEmail').value;
            const senha = document.getElementById('loginSenha').value;
            const btnLogin = document.getElementById('loginBtn');

            if (!email || !senha) {
                mostrarNotificacao('Preencha todos os campos', 'error');
                return;
            }

            setLoading(btnLogin, true);

            try {
                const response = await fetch('/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, senha })
                });

                const data = await response.json();

                if (response.ok) {
                    authToken = data.token;
                    currentUser = data.usuario;
                    localStorage.setItem('authToken', authToken);
                    mostrarNotificacao('Login realizado com sucesso!', 'success');
                    
                    // Autenticar WebSocket
                    autenticarWebSocket();
                    
                    mostrarAreaLogada();
                } else {
                    mostrarNotificacao(data.erro || 'Erro no login', 'error');
                }
            } catch (error) {
                mostrarNotificacao('Erro de conex√£o: ' + error.message, 'error');
            } finally {
                setLoading(btnLogin, false);
            }
        }

        async function fazerRegistro(event) {
            event.preventDefault();
            
            const nome = document.getElementById('regNome').value;
            const email = document.getElementById('regEmail').value;
            const senha = document.getElementById('regSenha').value;
            const btnRegister = document.getElementById('registerBtn');

            if (!nome || !email || !senha) {
                mostrarNotificacao('Preencha todos os campos', 'error');
                return;
            }

            if (senha.length < 6) {
                mostrarNotificacao('A senha deve ter pelo menos 6 caracteres', 'error');
                return;
            }

            setLoading(btnRegister, true);

            try {
                const response = await fetch('/registro', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ nome, email, senha })
                });

                const data = await response.json();

                if (response.ok) {
                    authToken = data.token;
                    currentUser = data.usuario;
                    localStorage.setItem('authToken', authToken);
                    mostrarNotificacao('Registro realizado com sucesso!', 'success');
                    
                    // Autenticar WebSocket
                    autenticarWebSocket();
                    
                    mostrarAreaLogada();
                } else {
                    mostrarNotificacao(data.erro || 'Erro no registro', 'error');
                }
            } catch (error) {
                mostrarNotificacao('Erro de conex√£o: ' + error.message, 'error');
            } finally {
                setLoading(btnRegister, false);
            }
        }

        async function verificarToken() {
            try {
                const response = await fetch('/perfil', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    currentUser = data.usuario;
                    
                    // Autenticar WebSocket
                    autenticarWebSocket();
                    
                    mostrarAreaLogada();
                } else {
                    logout();
                }
            } catch (error) {
                logout();
            }
        }

        function logout() {
            authToken = null;
            currentUser = null;
            correntistas = [];
            localStorage.removeItem('authToken');
            
            document.getElementById('auth-container').classList.remove('hidden');
            document.getElementById('main-header').classList.add('hidden');
            document.getElementById('main-app').classList.add('hidden');
            
            mostrarLogin();
        }

        function mostrarAreaLogada() {
            document.getElementById('auth-container').classList.add('hidden');
            document.getElementById('main-header').classList.remove('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            
            document.getElementById('header-user-name').textContent = currentUser.nome;
            
            // Load initial data
            carregarDashboard();
        }

        // Dashboard Functions
        async function carregarDashboard() {
            await Promise.all([
                carregarCorrentistas(),
                carregarMovimentacoes(),
                atualizarEstatisticas()
            ]);
        }

        async function carregarCorrentistas() {
            try {
                const response = await fetch('/correntistas', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    correntistas = await response.json();
                    atualizarListaContas();
                    atualizarSelectsContas();
                } else {
                    mostrarNotificacao('Erro ao carregar contas', 'error');
                }
            } catch (error) {
                mostrarNotificacao('Erro de conex√£o: ' + error.message, 'error');
            }
        }

        function atualizarListaContas() {
            const container = document.getElementById('contas-lista');
            
            if (correntistas.length === 0) {
                container.innerHTML = `
                    <p class="text-center" style="color: var(--text-secondary); padding: 2rem;">
                        Nenhuma conta encontrada
                    </p>
                `;
                return;
            }

            container.innerHTML = correntistas.map(conta => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; border: 1px solid var(--border-color); border-radius: 0.5rem; margin-bottom: 0.5rem;">
                    <div>
                        <div style="font-weight: 600;">${conta.NomeCorrentista}</div>
                        <div style="font-size: 0.875rem; color: var(--text-secondary);">Conta ${conta.CorrentistaID}</div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 1.25rem; font-weight: 700; color: var(--primary-color);">
                            ${formatarMoeda(conta.Saldo)}
                        </div>
                        <button class="btn btn-primary" style="font-size: 0.75rem; padding: 0.25rem 0.5rem; margin-top: 0.25rem;" onclick="verExtrato(${conta.CorrentistaID})">
                            Ver Extrato
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function atualizarSelectsContas() {
            const selects = [
                'depositoConta',
                'saqueConta', 
                'transferenciaOrigem',
                'transferenciaDestino',
                'pagamentoConta'
            ];

            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                const isDestino = selectId === 'transferenciaDestino';
                
                select.innerHTML = `<option value="">Selecione uma conta</option>` +
                    correntistas.map(conta => 
                        `<option value="${conta.CorrentistaID}">
                            ${conta.NomeCorrentista} - ${formatarMoeda(conta.Saldo)}
                        </option>`
                    ).join('');
            });
        }

        async function carregarMovimentacoes() {
            try {
                const response = await fetch('/movimentacoes', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    const movimentacoes = await response.json();
                    atualizarTabelaMovimentacoes(movimentacoes);
                } else {
                    mostrarNotificacao('Erro ao carregar movimenta√ß√µes', 'error');
                }
            } catch (error) {
                mostrarNotificacao('Erro de conex√£o: ' + error.message, 'error');
            }
        }

        function atualizarTabelaMovimentacoes(movimentacoes) {
            const tbody = document.getElementById('movimentacoes-tbody');
            
            if (movimentacoes.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center" style="padding: 2rem; color: var(--text-secondary);">
                            Nenhuma movimenta√ß√£o encontrada
                        </td>
                    </tr>
                `;
                return;
            }

            // Mostrar apenas as 10 mais recentes
            const recentes = movimentacoes.slice(0, 10);
            
            tbody.innerHTML = recentes.map(mov => `
                <tr>
                    <td>${formatarData(mov.DataOperacao)}</td>
                    <td>
                        <span class="text-${mov.TipoOperacao === 'Cr√©dito' ? 'success' : 'danger'}">
                            <i class="fas fa-${mov.TipoOperacao === 'Cr√©dito' ? 'arrow-down' : 'arrow-up'}"></i>
                            ${mov.TipoOperacao}
                        </span>
                    </td>
                    <td>${mov.Descricao}</td>
                    <td class="text-${mov.TipoOperacao === 'Cr√©dito' ? 'success' : 'danger'}">
                        ${mov.TipoOperacao === 'Cr√©dito' ? '+' : '-'} ${formatarMoeda(mov.ValorOperacao)}
                    </td>
                    <td>${mov.NomeCorrentista}</td>
                </tr>
            `).join('');
        }

        async function atualizarEstatisticas() {
            if (correntistas.length === 0) return;

            try {
                const response = await fetch('/movimentacoes', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    const movimentacoes = await response.json();
                    
                    const saldoTotal = correntistas.reduce((sum, conta) => sum + conta.Saldo, 0);
                    const receitas = movimentacoes
                        .filter(mov => mov.TipoOperacao === 'Cr√©dito')
                        .reduce((sum, mov) => sum + mov.ValorOperacao, 0);
                    const despesas = movimentacoes
                        .filter(mov => mov.TipoOperacao === 'D√©bito')
                        .reduce((sum, mov) => sum + mov.ValorOperacao, 0);

                    document.getElementById('saldo-total').textContent = formatarMoeda(saldoTotal);
                    document.getElementById('total-receitas').textContent = formatarMoeda(receitas);
                    document.getElementById('total-despesas').textContent = formatarMoeda(despesas);
                    document.getElementById('total-movimentacoes').textContent = movimentacoes.length;
                }
            } catch (error) {
                console.error('Erro ao carregar estat√≠sticas:', error);
            }
        }

        // Modal Functions
        function abrirModal(tipo) {
            if (correntistas.length === 0) {
                mostrarNotificacao('Carregue suas contas primeiro', 'warning');
                return;
            }

            const modalId = tipo + 'Modal';
            document.getElementById(modalId).classList.add('active');
            
            // Focus no primeiro input
            setTimeout(() => {
                const firstInput = document.querySelector(`#${modalId} input, #${modalId} select`);
                if (firstInput) firstInput.focus();
            }, 100);
        }

        function fecharModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            
            // Reset form
            const form = document.querySelector(`#${modalId} form`);
            if (form) form.reset();
        }

        // Transaction Functions
        async function realizarDeposito(event) {
            event.preventDefault();
            
            const contaId = document.getElementById('depositoConta').value;
            const valor = parseFloat(document.getElementById('depositoValor').value);
            
            if (!contaId || !valor || valor <= 0) {
                mostrarNotificacao('Preencha todos os campos corretamente', 'error');
                return;
            }

            try {
                const response = await fetch('/deposito', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        correntista_id: parseInt(contaId),
                        valor: valor
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    mostrarNotificacao(`Dep√≥sito de ${formatarMoeda(valor)} realizado com sucesso!`, 'success');
                    fecharModal('depositoModal');
                    carregarDashboard();
                } else {
                    mostrarNotificacao(data.erro || 'Erro ao realizar dep√≥sito', 'error');
                }
            } catch (error) {
                mostrarNotificacao('Erro de conex√£o: ' + error.message, 'error');
            }
        }

        async function realizarSaque(event) {
            event.preventDefault();
            
            const contaId = document.getElementById('saqueConta').value;
            const valor = parseFloat(document.getElementById('saqueValor').value);
            
            if (!contaId || !valor || valor <= 0) {
                mostrarNotificacao('Preencha todos os campos corretamente', 'error');
                return;
            }

            try {
                const response = await fetch('/saque', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        correntista_id: parseInt(contaId),
                        valor: valor
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    mostrarNotificacao(`Saque de ${formatarMoeda(valor)} realizado com sucesso!`, 'success');
                    fecharModal('saqueModal');
                    carregarDashboard();
                } else {
                    mostrarNotificacao(data.erro || 'Erro ao realizar saque', 'error');
                }
            } catch (error) {
                mostrarNotificacao('Erro de conex√£o: ' + error.message, 'error');
            }
        }

        async function realizarTransferencia(event) {
            event.preventDefault();
            
            const origemId = document.getElementById('transferenciaOrigem').value;
            const destinoId = document.getElementById('transferenciaDestino').value;
            const valor = parseFloat(document.getElementById('transferenciaValor').value);
            
            if (!origemId || !destinoId || !valor || valor <= 0) {
                mostrarNotificacao('Preencha todos os campos corretamente', 'error');
                return;
            }

            if (origemId === destinoId) {
                mostrarNotificacao('As contas de origem e destino devem ser diferentes', 'error');
                return;
            }

            try {
                const response = await fetch('/transferencia', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        correntista_id_origem: parseInt(origemId),
                        correntista_id_destino: parseInt(destinoId),
                        valor: valor
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    mostrarNotificacao(`Transfer√™ncia de ${formatarMoeda(valor)} realizada com sucesso!`, 'success');
                    fecharModal('transferenciaModal');
                    carregarDashboard();
                } else {
                    mostrarNotificacao(data.erro || 'Erro ao realizar transfer√™ncia', 'error');
                }
            } catch (error) {
                mostrarNotificacao('Erro de conex√£o: ' + error.message, 'error');
            }
        }

        async function realizarPagamento(event) {
            event.preventDefault();
            
            const contaId = document.getElementById('pagamentoConta').value;
            const descricao = document.getElementById('pagamentoDescricao').value;
            const valor = parseFloat(document.getElementById('pagamentoValor').value);
            
            if (!contaId || !descricao || !valor || valor <= 0) {
                mostrarNotificacao('Preencha todos os campos corretamente', 'error');
                return;
            }

            try {
                const response = await fetch('/pagamento', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        correntista_id: parseInt(contaId),
                        valor: valor,
                        descricao: descricao
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    mostrarNotificacao(`Pagamento "${descricao}" de ${formatarMoeda(valor)} realizado com sucesso!`, 'success');
                    fecharModal('pagamentoModal');
                    carregarDashboard();
                } else {
                    mostrarNotificacao(data.erro || 'Erro ao realizar pagamento', 'error');
                }
            } catch (error) {
                mostrarNotificacao('Erro de conex√£o: ' + error.message, 'error');
            }
        }

        async function verExtrato(contaId) {
            try {
                const response = await fetch(`/extrato/${contaId}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    const extrato = await response.json();
                    mostrarExtratoModal(extrato, contaId);
                } else {
                    mostrarNotificacao('Erro ao carregar extrato', 'error');
                }
            } catch (error) {
                mostrarNotificacao('Erro de conex√£o: ' + error.message, 'error');
            }
        }

        function mostrarExtratoModal(extrato, contaId) {
            const conta = correntistas.find(c => c.CorrentistaID === contaId);
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px;">
                    <div class="modal-header">
                        <h3><i class="fas fa-file-alt"></i> Extrato - ${conta.NomeCorrentista}</h3>
                        <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th>Tipo</th>
                                    <th>Descri√ß√£o</th>
                                    <th>Valor</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${extrato.length > 0 ? extrato.map(mov => `
                                    <tr>
                                        <td>${formatarData(mov.DataOperacao)}</td>
                                        <td>
                                            <span class="text-${mov.TipoOperacao === 'Cr√©dito' ? 'success' : 'danger'}">
                                                <i class="fas fa-${mov.TipoOperacao === 'Cr√©dito' ? 'arrow-down' : 'arrow-up'}"></i>
                                                ${mov.TipoOperacao}
                                            </span>
                                        </td>
                                        <td>${mov.Descricao}</td>
                                        <td class="text-${mov.TipoOperacao === 'Cr√©dito' ? 'success' : 'danger'}">
                                            ${mov.TipoOperacao === 'Cr√©dito' ? '+' : '-'} ${formatarMoeda(mov.ValorOperacao)}
                                        </td>
                                    </tr>
                                `).join('') : `
                                    <tr>
                                        <td colspan="4" class="text-center" style="padding: 2rem; color: var(--text-secondary);">
                                            Nenhuma movimenta√ß√£o encontrada
                                        </td>
                                    </tr>
                                `}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // Close modals when clicking outside
        document.addEventListener('click', function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('active');
            }
        });

        // Close modals with Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                document.querySelectorAll('.modal.active').forEach(modal => {
                    modal.classList.remove('active');
                });
            }
        });
    </script>
</body>
</html>